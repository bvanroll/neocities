name: Deploy to neocities
on:
  push:
    branches: 
      - master

env:
  FORCE_COLOR: 1
  node_version: lts/*

concurrency:
  group: deploy-to-neocities
  cancel-in-progress: true


jobs:
  setup:
    runs-on: ubuntu-latest 
    outputs: 
      matrix: ${{ steps.matrix.outputs.matrix }}
      genhtml: ${{ steps.genhtml.outputs.genhtml }}
    steps:
      - uses: actions/checkout@v4
      - name: create matrix
        id: matrix
        run: |
          cd ${{ github.workspace }}
          test=$(./compile.sh)
          echo "matrix=$test" >> $GITHUB_OUTPUT
      - name: genhtml
        id: genhtml
        run: |
          cd ${{ github.workspace }} 
          test=$(./genhtml.sh)
          echo "genhtml=$test" >> $GITHUB_OUTPUT
          
  build:
    needs: [ setup ]
    runs-on: ubuntu-latest
    strategy:
      matrix: 
        value: ${{fromJSON(needs.setup.outputs.matrix)}}
    steps:
      - uses: actions/checkout@v4
      #- run: |
      #    cd ${{ github.workspace }}
      #    touch ${{ matrix.value.dest }}
      - name: markdown to html 
        uses: jaywcjlove/markdown-to-html-cli@main 
        with:
          source: ${{ matrix.value.source }}
          output: ${{ matrix.value.dest }}
          github-corners: https://github.com/jaywcjlove/markdown-to-html-cliA

  deploy:
    needs: [ build ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: finish posts.html 
        env:
          genhtml: ${{ needs.setup.outputs.genhtml }}
        run: |
          echo "$genhtml" > ${{ github.workspace}}/public/posts.html
          echo $genhtml
          #TODO this turns up empty right now. gotta figure that shit out i think
      - name: Deploy to neocities 
        uses: bcomnes/deploy-to-neocities@v1
        with: 
          api_token: ${{ secrets.NEOCITIES_API_TOKEN }}
          cleanup: true 
          dist_dir: public 
          protected_files: 'dropbox/*'
